name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout du code source
    - uses: actions/checkout@v4

    - name: 'Create env file'
      run: |
        touch .env
        echo API_ENDPOINT= ${{ vars.BACK_URL }} >> .env
        echo JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }} >> .env
        cat .env
        
    # Build de l'image Docker
    - name: Build the Docker image
      run: |
        docker build . --file Dockerfile --tag digilbum-front:${{ github.run_number }}
      env:
        TAG: ${{ github.run_number }}

    # Envoi de l'image vers la VM via SSH
    - name: Save Docker image to a file
      run: docker save digilbum-front:${{ github.run_number }} | gzip > digilbum-front.tar.gz

    - name: Transfer Docker image to VM
      uses: appleboy/scp-action@master
      with:
        source: "digilbum-front.tar.gz, .env"
        target: "~/app/front/"
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}

    # Chargement et lancement de l'image sur la VM
    - name: Deploy Docker image on VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          docker load < ~/app/front/digilbum-front.tar.gz
          docker run -d -p 3000:3000 -p 3010:3010 --env-file ~/app/front/.env digilbum-front:${{ github.run_number }}
